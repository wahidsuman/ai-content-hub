---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const tags = new Set();
  
  posts.forEach(post => {
    if (post.data.tags) {
      post.data.tags.forEach(tag => tags.add(tag));
    }
  });
  
  return Array.from(tags).map(tag => ({
    params: { tag },
    props: { tag }
  }));
}

const { tag } = Astro.props;
const posts = await getCollection('blog');
const filteredPosts = posts
  .filter(post => post.data.tags?.includes(tag))
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

const tagEmoji = {
  'tech': 'üíª',
  'ev': 'üöó',
  'crypto': '‚Çø',
  'gadgets': 'üì±'
}[tag] || 'üì∞';

const tagTitle = {
  'tech': 'Technology',
  'ev': 'Electric Vehicles',
  'crypto': 'Cryptocurrency',
  'gadgets': 'Gadgets'
}[tag] || tag;
---

<Layout title={`${tagTitle} News - Tech News Blog`}>
  <div class="max-w-6xl mx-auto">
    <!-- Tag Header -->
    <header class="text-center mb-12">
      <div class="text-6xl mb-4">{tagEmoji}</div>
      <h1 class="text-4xl font-bold text-gray-900 mb-4">{tagTitle} News</h1>
      <p class="text-xl text-gray-600">
        Latest {tagTitle.toLowerCase()} news and updates
      </p>
      <div class="mt-4">
        <a href="/" class="text-primary-600 hover:text-primary-700 font-medium">
          ‚Üê Back to all news
        </a>
      </div>
    </header>

    <!-- Articles Grid -->
    {filteredPosts.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {filteredPosts.map((post) => (
          <article class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
            <div class="p-6">
              <div class="flex items-center gap-4 mb-3">
                <span class="text-sm text-gray-500">
                  {new Date(post.data.date).toLocaleDateString()}
                </span>
                <span class="text-sm text-primary-600 font-medium">
                  {post.data.source}
                </span>
              </div>
              <h3 class="text-lg font-semibold mb-3 text-gray-900 line-clamp-2">
                <a href={`/blog/${post.slug}`} class="hover:text-primary-600 transition-colors">
                  {post.data.title}
                </a>
              </h3>
              <p class="text-gray-600 mb-4 text-sm line-clamp-3">
                {post.data.description}
              </p>
              <div class="flex flex-wrap gap-2 mb-4">
                {post.data.tags?.slice(0, 3).map((postTag: string) => (
                  <a 
                    href={`/tags/${postTag}`} 
                    class={`px-2 py-1 rounded text-xs transition-colors ${
                      postTag === tag 
                        ? 'bg-primary-100 text-primary-800' 
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    {postTag}
                  </a>
                ))}
              </div>
              <a href={`/blog/${post.slug}`} class="text-primary-600 hover:text-primary-700 text-sm font-medium">
                Read more ‚Üí
              </a>
            </div>
          </article>
        ))}
      </div>
    ) : (
      <div class="text-center py-12">
        <div class="text-6xl mb-4">üì≠</div>
        <h2 class="text-2xl font-bold text-gray-900 mb-4">No articles found</h2>
        <p class="text-gray-600 mb-8">
          No articles found for the "{tag}" tag yet. Check back soon!
        </p>
        <a href="/" class="bg-primary-600 text-white px-6 py-3 rounded-lg hover:bg-primary-700 transition-colors">
          Browse all articles
        </a>
      </div>
    )}

    <!-- RSS Feed Link -->
    {filteredPosts.length > 0 && (
      <div class="mt-12 text-center">
        <p class="text-gray-600 mb-4">
          Stay updated with the latest {tagTitle.toLowerCase()} news
        </p>
        <a 
          href="/rss.xml" 
          class="inline-flex items-center gap-2 bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M5 3a1 1 0 000 2c5.523 0 10 4.477 10 10a1 1 0 102 0C17 8.373 11.627 3 5 3z"/>
            <path d="M4 9a1 1 0 011-1 7 7 0 017 7 1 1 0 11-2 0 5 5 0 00-5-5 1 1 0 01-1-1z"/>
            <path d="M3 15a2 2 0 114 0 2 2 0 01-4 0z"/>
          </svg>
          Subscribe to RSS Feed
        </a>
      </div>
    )}
  </div>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>